<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flash Device</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { EspLoader } from 'https://unpkg.com/esptool-js@latest/dist/web/index.js';

    let port, loader;

    async function connect() {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      loader = new EspLoader(port);
      await loader.connect();
      const chip = await loader.chipName();
      log(`Connected to: ${chip}`);
    }

    async function flash() {
      const file = document.getElementById("binfile").files[0];
      if (!file) {
        log(\"No file selected.\");
        return;
      }
      const arrayBuffer = await file.arrayBuffer();
      const firmware = new Uint8Array(arrayBuffer);
      await loader.flashData(0x1000, firmware);
      log(\"Flashing complete!\");
    }

    function log(message) {
      document.getElementById(\"log\").textContent += `\\n> ${message}`;
    }

    window.onload = () => {
      document.getElementById(\"connectBtn\").onclick = connect;
      document.getElementById(\"flashBtn\").onclick = flash;
    };
  </script>
</head>
<body>
  <header>
    <h1>ESP32 WiFi Duck - Flasher</h1>
    <nav>
      <a href=\"index.html\">Home</a>
      <a href=\"flash.html\">Flash Device</a>
    </nav>
  </header>

  <main>
    <section class=\"panel\">
      <h2 class=\"label green\">| Flash Your Device</h2>
      <p>Select your ESP32 binary and flash it directly over USB using Web Serial + esptool-js.</p>
      <input type=\"file\" id=\"binfile\" accept=\".bin\" /><br><br>
      <button class=\"btn\" id=\"connectBtn\">ðŸ”Œ Connect</button>
      <button class=\"btn blue\" id=\"flashBtn\">âš¡ Flash</button>
    </section>

    <section class=\"panel\">
      <h2 class=\"label\">| Output Log</h2>
      <pre id=\"log\">Waiting for connection...</pre>
    </section>
  </main>

  <footer>
    <p>Flasher powered by <a href=\"https://github.com/espressif/esptool-js\" target=\"_blank\">esptool-js</a></p>
  </footer>
</body>
</html>
