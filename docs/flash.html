<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flash Device</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { ESPLoader, Transport } from 'https://cdn.jsdelivr.net/npm/esptool-js@0.5.6/bundle.min.js';
    import { unzipSync } from 'https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js';
    // optional: import CryptoJS if you want MD5 verification
    import CryptoJS from 'https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/index.min.js';

    let port, loader;

    async function connect() {
      // ask the browser for a serial port
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      const transport = new Transport(port);

      // create ESPLoader with options (baudrate and a terminal interface)
      loader = new ESPLoader({
        transport,
        baudrate: 115200,
        terminal: {
          clean() {},
          writeLine: msg => log(msg),
          write: msg => log(msg)
        },
        debugLogging: false,
      });

      // main() connects, detects the chip and runs the stub
      const chip = await loader.main();
      log(`Connected to: ${chip}`);
    }

    async function flash() {
      const url = document.getElementById("deviceSelect").value;
      if (!url) {
        log("Please select a device build.");
        return;
      }

      const erase = document.getElementById("eraseCheckbox").checked;
      const zipData = await fetch(url).then(r => r.arrayBuffer());
      const files = unzipSync(new Uint8Array(zipData));

      // build the list of image segments; convert Uint8Array to binary string
      const segments = [
        { name: "bootloader.bin", address: 0x0000 },
        { name: "partitions.bin", address: 0x8000 },
        { name: "firmware.bin",   address: 0x10000 },
      ];
      const fileArray = [];
      for (const { name, address } of segments) {
        const data = files[name];
        if (data) {
          fileArray.push({ data: loader.ui8ToBstr(data), address });
        } else {
          log(`Missing ${name} in zip.`);
        }
      }
      if (fileArray.length === 0) {
        log("No firmware images found.");
        return;
      }

      log("Flashingâ€¦");
      await loader.writeFlash({
        fileArray,
        flashSize: 'keep',      // preserve the existing flash size setting
        eraseAll: erase,        // erase before programming if the user checked the box
        compress: true,         // compress data while flashing (matches esptool-js default)
        reportProgress: (fileIdx, written, total) => {
          const percent = Math.floor((written / total) * 100);
          log(`Image ${fileIdx + 1}: ${percent}%`);
        },
        // optional MD5: calculateMD5Hash: img => CryptoJS.MD5(CryptoJS.enc.Latin1.parse(img)).toString(),
      });
      // reset the chip so it boots the new firmware
      await loader.after();
      log("âœ… Flash complete.");
    }

    // helper to append log text into the <pre id="log">
    function log(msg) {
      const logEl = document.getElementById("log");
      logEl.textContent += `\n> ${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    window.onload = () => {
      document.getElementById("connectBtn").onclick = connect;
      document.getElementById("flashBtn").onclick = flash;
      document.getElementsByName("releaseType").forEach(r => r.onchange = loadReleases);
      document.getElementById("releaseSelect").onchange = populateDeviceList;
      loadReleases();
    };
  </script>
</head>
<body>
  <header>
    <h1>ESP32 WiFi Duck - Flasher</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="flash.html">Flash Device</a>
    </nav>
  </header>

  <main>
    <section class="panel">
      <h2 class="label green">| Flash Your Device</h2>
      <p>Select from stable or nightly builds, then choose your device.</p>

      <label><input type="radio" name="releaseType" value="stable"> Latest Stable Release</label>
      <label><input type="radio" name="releaseType" value="nightly" checked> Nightly Builds</label>
      <br><br>

      <label for="releaseSelect">Choose release:</label><br>
      <select id="releaseSelect"></select><br><br>

      <label for="deviceSelect">Choose device type:</label><br>
      <select id="deviceSelect"></select><br><br>

      <label><input type="checkbox" id="eraseCheckbox"> Erase flash before writing</label><br><br>

      <button class="btn" id="connectBtn">ðŸ”Œ Connect</button>
      <button class="btn blue" id="flashBtn">âš¡ Flash</button>
    </section>

    <section class="panel">
      <h2 class="label">| Output Log</h2>
      <pre id="log">Waiting for connection...</pre>
    </section>
  </main>

  <footer>
    <p>Flasher powered by <a href="https://github.com/espressif/esptool-js" target="_blank">esptool-js</a></p>
  </footer>
</body>
</html>
