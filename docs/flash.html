<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flash Device</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import esptool from './esptool.js';
    const { ESPLoader, TransportWebSerial } = esptool;

    let port, loader;

    async function connect() {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      const transport = new TransportWebSerial(port);
      loader = new ESPLoader(transport, { log });
      await loader.initialize();
      const chip = await loader.chipName();
      log(`Connected to: ${chip}`);
    }

    function log(message) {
      const logEl = document.getElementById("log");
      logEl.textContent += `\n> ${message}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function loadReleases() {
      const releaseType = document.querySelector('input[name="releaseType"]:checked').value;
      const releaseSelect = document.getElementById("releaseSelect");
      const deviceSelect = document.getElementById("deviceSelect");
      releaseSelect.innerHTML = "<option value=''>Loading...</option>";
      deviceSelect.innerHTML = "<option value=''>Select a release first</option>";

      try {
        const response = await fetch("https://api.github.com/repos/x0SiN0x/n3wbWiFiDucky/releases");
        if (!response.ok) throw new Error("GitHub API error");
        const releases = await response.json();
        const filtered = releases.filter(r =>
          releaseType === 'nightly' ? r.tag_name.startsWith('nightly-') : r.tag_name.startsWith('v')
        ).slice(0, 30);

        releaseSelect.innerHTML = "<option value=''>Select release</option>";
        filtered.forEach(rel => {
          const opt = document.createElement("option");
          opt.value = rel.tag_name;
          opt.textContent = `${rel.name || rel.tag_name}`;
          releaseSelect.appendChild(opt);
        });
      } catch (err) {
        releaseSelect.innerHTML = "<option value=''>Failed to load releases</option>";
        log(`[ERROR] Failed to load GitHub releases: ${err.message}`);
      }
    }

    async function populateDeviceList() {
      const tag = document.getElementById("releaseSelect").value;
      const deviceSelect = document.getElementById("deviceSelect");
      deviceSelect.innerHTML = "";

      try {
        const release = await fetch(`https://api.github.com/repos/x0SiN0x/n3wbWiFiDucky/releases/tags/${tag}`).then(r => r.json());
        release.assets.forEach(asset => {
          if (asset.name.endsWith(".zip")) {
            const opt = document.createElement("option");
            opt.value = asset.browser_download_url;
            opt.textContent = asset.name.replace('.zip','').replace(/-/g,' ');
            deviceSelect.appendChild(opt);
          }
        });
      } catch (err) {
        deviceSelect.innerHTML = "<option value=''>Error loading devices</option>";
        log(`[ERROR] Failed to fetch device list: ${err.message}`);
      }
    }

    async function flash() {
      const url = document.getElementById("deviceSelect").value;
      if (!url) return log("Please select a device build.");

      const erase = document.getElementById("eraseCheckbox").checked;
      const zipData = await fetch(url).then(r => r.arrayBuffer());
      const { unzipSync } = await import("https://cdn.jsdelivr.net/npm/fflate@0.8.0/esm/index.js");
      const files = unzipSync(new Uint8Array(zipData));

      if (erase) {
        log("Erasing flash...");
        await loader.eraseFlash();
      }

      const segments = [
        { name: "bootloader.bin", address: 0x0000 },
        { name: "partitions.bin", address: 0x8000 },
        { name: "firmware.bin", address: 0x10000 }
      ];

      for (const { name, address } of segments) {
        const file = files[name];
        if (file) {
          log(`Flashing ${name} to 0x${address.toString(16)}`);
          await loader.flashData(address, file);
        } else {
          log(`Missing ${name} in zip.`);
        }
      }

      log("âœ… Flash complete.");
    }

    window.onload = () => {
      document.getElementById("connectBtn").onclick = connect;
      document.getElementById("flashBtn").onclick = flash;
      document.getElementsByName("releaseType").forEach(r => r.onchange = loadReleases);
      document.getElementById("releaseSelect").onchange = populateDeviceList;
      loadReleases();
    };
  </script>
</head>
<body>
  <header>
    <h1>ESP32 WiFi Duck - Flasher</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="flash.html">Flash Device</a>
    </nav>
  </header>

  <main>
    <section class="panel">
      <h2 class="label green">| Flash Your Device</h2>
      <p>Select from stable or nightly builds, then choose your device.</p>

      <label><input type="radio" name="releaseType" value="stable"> Latest Stable Release</label>
      <label><input type="radio" name="releaseType" value="nightly" checked> Nightly Builds</label>
      <br><br>

      <label for="releaseSelect">Choose release:</label><br>
      <select id="releaseSelect"></select><br><br>

      <label for="deviceSelect">Choose device type:</label><br>
      <select id="deviceSelect"></select><br><br>

      <label><input type="checkbox" id="eraseCheckbox"> Erase flash before writing</label><br><br>

      <button class="btn" id="connectBtn">ðŸ”Œ Connect</button>
      <button class="btn blue" id="flashBtn">âš¡ Flash</button>
    </section>

    <section class="panel">
      <h2 class="label">| Output Log</h2>
      <pre id="log">Waiting for connection...</pre>
    </section>
  </main>

  <footer>
    <p>Flasher powered by <a href="https://github.com/espressif/esptool-js" target="_blank">esptool-js</a></p>
  </footer>
</body>
</html>
