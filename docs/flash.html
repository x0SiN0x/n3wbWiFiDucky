<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flash Device</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.6/bundle.js';
    import { unzipSync } from 'https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js';

    let port, loader;

    // Request a serial port and create the loader
    async function connect() {
      // Request the serial port from the browser
      port = await navigator.serial.requestPort();
      // Don't call port.open() here â€” esptool-js will do that for you
      const transport = new Transport(port);

      loader = new ESPLoader({
        transport,
        baudrate: 115200,
        terminal: {
          clean() {},
          writeLine: msg => log(msg),
          write: msg => log(msg),
        },
        debugLogging: false
      });

      // loader.main() will call transport.connect() internally and open the port
      const chip = await loader.main();
      log(`Connected to: ${chip}`);
    }

    // Flash a firmware ZIP selected by the user
    async function flash() {
      const url = document.getElementById('deviceSelect').value;
      if (!url) {
        log('Please select a device build.');
        return;
      }

      const erase = document.getElementById('eraseCheckbox').checked;
      const zipData = await fetch(url).then(r => r.arrayBuffer());
      const files = unzipSync(new Uint8Array(zipData));

      // Build list of image segments
      const segments = [
        { name: 'bootloader.bin', address: 0x0000 },
        { name: 'partitions.bin', address: 0x8000 },
        { name: 'firmware.bin',   address: 0x10000 },
      ];
      const fileArray = [];
      for (const { name, address } of segments) {
        const data = files[name];
        if (data) {
          fileArray.push({ data: loader.ui8ToBstr(data), address });
        } else {
          log(`Missing ${name} in zip.`);
        }
      }
      if (fileArray.length === 0) {
        log('No firmware images found.');
        return;
      }

      log('Flashingâ€¦');
      await loader.writeFlash({
        fileArray,
        flashSize: 'keep',
        eraseAll: erase,
        compress: true,
        reportProgress: (fileIdx, written, total) => {
          const percent = Math.floor((written / total) * 100);
          log(`Image ${fileIdx + 1}: ${percent}%`);
        }
      });
      await loader.after();  // reset the chip so it boots the new firmware
      log('âœ… Flash complete.');
    }

    async function loadReleases() {
      const releaseType = document.querySelector('input[name="releaseType"]:checked').value;
      const releaseSelect = document.getElementById("releaseSelect");
      const deviceSelect = document.getElementById("deviceSelect");
      releaseSelect.innerHTML = "<option value=''>Loading...</option>";
      deviceSelect.innerHTML = "<option value=''>Select a release first</option>";

      const response = await fetch("https://api.github.com/repos/x0SiN0x/n3wbWiFiDucky/releases");
      const releases = await response.json();
      const filtered = releases.filter(r =>
        releaseType === 'nightly' ? r.tag_name.startsWith('nightly-') : r.tag_name.startsWith('v')
      ).slice(0, 30);

      releaseSelect.innerHTML = "<option value=''>Select release</option>";
      filtered.forEach(rel => {
        const opt = document.createElement("option");
        opt.value = rel.tag_name;
        opt.textContent = `${rel.name || rel.tag_name}`;
        releaseSelect.appendChild(opt);
      });
    }

    async function populateDeviceList() {
      const tag = document.getElementById("releaseSelect").value;
      const release = await fetch(`https://api.github.com/repos/x0SiN0x/n3wbWiFiDucky/releases/tags/${tag}`).then(r => r.json());
      const deviceSelect = document.getElementById("deviceSelect");
      deviceSelect.innerHTML = "";

      release.assets.forEach(asset => {
        if (asset.name.endsWith(".zip")) {
          const opt = document.createElement("option");
          opt.value = asset.browser_download_url;
          opt.textContent = asset.name.replace('.zip','').replace(/-/g,' ');
          deviceSelect.appendChild(opt);
        }
      });
    }

    // Append text into the <pre id="log">
    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += `\n> ${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Hook up UI events on page load
    window.onload = () => {
      document.getElementById('connectBtn').onclick = connect;
      document.getElementById('flashBtn').onclick = flash;
      document.getElementsByName('releaseType').forEach(r => r.onchange = loadReleases);
      document.getElementById('releaseSelect').onchange = populateDeviceList;
      loadReleases();
    };
  </script>
</head>
<body>
  <header>
    <h1>ESP32 WiFi Duck - Flasher</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="flash.html">Flash Device</a>
    </nav>
  </header>

  <main>
    <section class="panel">
      <h2 class="label green">| Flash Your Device</h2>
      <p>Select from stable or nightly builds, then choose your device.</p>

      <label><input type="radio" name="releaseType" value="stable"> Latest Stable Release</label>
      <label><input type="radio" name="releaseType" value="nightly" checked> Nightly Builds</label>
      <br><br>

      <label for="releaseSelect">Choose release:</label><br>
      <select id="releaseSelect"></select><br><br>

      <label for="deviceSelect">Choose device type:</label><br>
      <select id="deviceSelect"></select><br><br>

      <label><input type="checkbox" id="eraseCheckbox"> Erase flash before writing</label><br><br>

      <button class="btn" id="connectBtn">ðŸ”Œ Connect</button>
      <button class="btn blue" id="flashBtn">âš¡ Flash</button>
    </section>

    <section class="panel">
      <h2 class="label">| Output Log</h2>
      <pre id="log">Waiting for connection...</pre>
    </section>
  </main>

  <footer>
    <p>Flasher powered by <a href="https://github.com/espressif/esptool-js" target="_blank">esptool-js</a></p>
  </footer>
</body>
</html>
